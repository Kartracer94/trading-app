<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trading Confluence Analyzer</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/recharts@2.5.0/dist/Recharts.js"></script>
  <script src="https://unpkg.com/lucide-react@0.263.1/dist/umd/lucide-react.js"></script>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect } = React;
    const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend } = Recharts;
    const { TrendingUp, TrendingDown, Minus, AlertCircle } = lucideReact;

    const TradingApp = () => {
      const [priceData, setPriceData] = useState([]);
      const [analysis, setAnalysis] = useState(null);
      const [timeframe, setTimeframe] = useState('1H');
      const [symbol, setSymbol] = useState('BTC/USD');

      // Generate sample price data
      const generatePriceData = () => {
        const data = [];
        let price = 45000;
        const trend = Math.random() > 0.5 ? 1 : -1;
        
        for (let i = 0; i < 100; i++) {
          const volatility = price * 0.02;
          const change = (Math.random() - 0.4) * volatility * trend;
          price = price + change;
          
          const high = price + Math.random() * volatility * 0.5;
          const low = price - Math.random() * volatility * 0.5;
          const open = i === 0 ? price : data[i-1].close;
          
          data.push({
            time: i,
            open: parseFloat(open.toFixed(2)),
            high: parseFloat(high.toFixed(2)),
            low: parseFloat(low.toFixed(2)),
            close: parseFloat(price.toFixed(2)),
          });
        }
        return data;
      };

      // Calculate SMA
      const calculateSMA = (data, period) => {
        if (!data || data.length < period) return [];
        
        const sma = [];
        for (let i = 0; i < data.length; i++) {
          if (i < period - 1) {
            sma.push(null);
          } else {
            const sum = data.slice(i - period + 1, i + 1).reduce((acc, val) => acc + (val?.close || 0), 0);
            sma.push(sum / period);
          }
        }
        return sma;
      };

      // Calculate EMA
      const calculateEMA = (data, period) => {
        if (!data || data.length < period) return [];
        
        const ema = [];
        const multiplier = 2 / (period + 1);
        
        // Start with SMA
        let sum = 0;
        for (let i = 0; i < period; i++) {
          sum += data[i]?.close || 0;
        }
        ema[period - 1] = sum / period;
        
        for (let i = period; i < data.length; i++) {
          const closeValue = data[i]?.close || 0;
          ema[i] = (closeValue - ema[i - 1]) * multiplier + ema[i - 1];
        }
        
        return ema;
      };

      // Calculate RSI
      const calculateRSI = (data, period = 14) => {
        if (!data || data.length < period + 1) return [];
        
        const rsi = [];
        let gains = 0;
        let losses = 0;
        
        for (let i = 1; i <= period; i++) {
          const change = (data[i]?.close || 0) - (data[i - 1]?.close || 0);
          if (change > 0) gains += change;
          else losses += Math.abs(change);
        }
        
        let avgGain = gains / period;
        let avgLoss = losses / period;
        
        for (let i = 0; i < data.length; i++) {
          if (i < period) {
            rsi.push(null);
          } else {
            const rs = avgLoss === 0 ? 100 : avgGain / avgLoss;
            rsi.push(100 - (100 / (1 + rs)));
            
            if (i < data.length - 1) {
              const change = (data[i + 1]?.close || 0) - (data[i]?.close || 0);
              avgGain = ((avgGain * (period - 1)) + (change > 0 ? change : 0)) / period;
              avgLoss = ((avgLoss * (period - 1)) + (change < 0 ? Math.abs(change) : 0)) / period;
            }
          }
        }
        
        return rsi;
      };

      // Calculate MACD
      const calculateMACD = (data) => {
        const ema12 = calculateEMA(data, 12);
        const ema26 = calculateEMA(data, 26);
        const macdLine = ema12.map((val, i) => val && ema26[i] ? val - ema26[i] : null);
        
        const macdData = macdLine.map((val, i) => ({ close: val || 0 }));
        const signalLine = calculateEMA(macdData, 9);
        const histogram = macdLine.map((val, i) => val && signalLine[i] ? val - signalLine[i] : null);
        
        return { macdLine, signalLine, histogram };
      };

      // Identify support and resistance levels
      const findSupportResistance = (data) => {
        const levels = [];
        const window = 10;
        
        for (let i = window; i < data.length - window; i++) {
          const slice = data.slice(i - window, i + window);
          const current = data[i];
          
          // Check for resistance (local high)
          const isResistance = slice.every(d => current.high >= d.high);
          if (isResistance) {
            levels.push({ price: current.high, type: 'resistance', index: i });
          }
          
          // Check for support (local low)
          const isSupport = slice.every(d => current.low <= d.low);
          if (isSupport) {
            levels.push({ price: current.low, type: 'support', index: i });
          }
        }
        
        return levels;
      };

      // Analyze confluences
      const analyzeConfluences = (data) => {
        if (!data || data.length < 50) return null;
        
        const sma20 = calculateSMA(data, 20);
        const sma50 = calculateSMA(data, 50);
        const ema9 = calculateEMA(data, 9);
        const rsi = calculateRSI(data);
        const macd = calculateMACD(data);
        const levels = findSupportResistance(data);
        
        const lastIdx = data.length - 1;
        const currentPrice = data[lastIdx]?.close || 0;
        
        // Determine trend
        let trendScore = 0;
        let trendSignal = 'NEUTRAL';
        
        // Trend confluence checks
        const confluences = [];
        
        // 1. Price vs SMAs
        if (currentPrice > sma20[lastIdx] && currentPrice > sma50[lastIdx]) {
          trendScore += 2;
          confluences.push({ name: 'Price Above SMAs', signal: 'BULLISH', weight: 2 });
        } else if (currentPrice < sma20[lastIdx] && currentPrice < sma50[lastIdx]) {
          trendScore -= 2;
          confluences.push({ name: 'Price Below SMAs', signal: 'BEARISH', weight: 2 });
        }
        
        // 2. SMA Crossover
        if (sma20[lastIdx] > sma50[lastIdx] && sma20[lastIdx - 1] <= sma50[lastIdx - 1]) {
          trendScore += 3;
          confluences.push({ name: 'Golden Cross (SMA20/50)', signal: 'BULLISH', weight: 3 });
        } else if (sma20[lastIdx] < sma50[lastIdx] && sma20[lastIdx - 1] >= sma50[lastIdx - 1]) {
          trendScore -= 3;
          confluences.push({ name: 'Death Cross (SMA20/50)', signal: 'BEARISH', weight: 3 });
        } else if (sma20[lastIdx] > sma50[lastIdx]) {
          trendScore += 1;
          confluences.push({ name: 'SMA20 Above SMA50', signal: 'BULLISH', weight: 1 });
        } else if (sma20[lastIdx] < sma50[lastIdx]) {
          trendScore -= 1;
          confluences.push({ name: 'SMA20 Below SMA50', signal: 'BEARISH', weight: 1 });
        }
        
        // 3. RSI
        if (rsi[lastIdx] > 50 && rsi[lastIdx] < 70) {
          trendScore += 1;
          confluences.push({ name: 'RSI Bullish Zone', signal: 'BULLISH', weight: 1 });
        } else if (rsi[lastIdx] < 50 && rsi[lastIdx] > 30) {
          trendScore -= 1;
          confluences.push({ name: 'RSI Bearish Zone', signal: 'BEARISH', weight: 1 });
        } else if (rsi[lastIdx] > 70) {
          confluences.push({ name: 'RSI Overbought', signal: 'WARNING', weight: 0 });
        } else if (rsi[lastIdx] < 30) {
          confluences.push({ name: 'RSI Oversold', signal: 'WARNING', weight: 0 });
        }
        
        // 4. MACD
        if (macd.histogram[lastIdx] > 0 && macd.histogram[lastIdx - 1] <= 0) {
          trendScore += 2;
          confluences.push({ name: 'MACD Bullish Cross', signal: 'BULLISH', weight: 2 });
        } else if (macd.histogram[lastIdx] < 0 && macd.histogram[lastIdx - 1] >= 0) {
          trendScore -= 2;
          confluences.push({ name: 'MACD Bearish Cross', signal: 'BEARISH', weight: 2 });
        } else if (macd.histogram[lastIdx] > 0) {
          trendScore += 1;
          confluences.push({ name: 'MACD Positive', signal: 'BULLISH', weight: 1 });
        } else if (macd.histogram[lastIdx] < 0) {
          trendScore -= 1;
          confluences.push({ name: 'MACD Negative', signal: 'BEARISH', weight: 1 });
        }
        
        // 5. Support/Resistance proximity
        const nearestSupport = levels.filter(l => l.type === 'support' && l.price < currentPrice)
          .sort((a, b) => b.price - a.price)[0];
        const nearestResistance = levels.filter(l => l.type === 'resistance' && l.price > currentPrice)
          .sort((a, b) => a.price - b.price)[0];
        
        if (nearestSupport && (currentPrice - nearestSupport.price) / currentPrice < 0.02) {
          confluences.push({ name: 'Near Support Level', signal: 'BULLISH', weight: 1 });
          trendScore += 1;
        }
        
        if (nearestResistance && (nearestResistance.price - currentPrice) / currentPrice < 0.02) {
          confluences.push({ name: 'Near Resistance Level', signal: 'BEARISH', weight: 1 });
          trendScore -= 1;
        }
        
        // Determine overall signal
        if (trendScore >= 5) trendSignal = 'STRONG BUY';
        else if (trendScore >= 3) trendSignal = 'BUY';
        else if (trendScore >= 1) trendSignal = 'WEAK BUY';
        else if (trendScore <= -5) trendSignal = 'STRONG SELL';
        else if (trendScore <= -3) trendSignal = 'SELL';
        else if (trendScore <= -1) trendSignal = 'WEAK SELL';
        else trendSignal = 'NEUTRAL';
        
        return {
          trendScore,
          trendSignal,
          confluences,
          indicators: {
            sma20: sma20[lastIdx]?.toFixed(2),
            sma50: sma50[lastIdx]?.toFixed(2),
            ema9: ema9[lastIdx]?.toFixed(2),
            rsi: rsi[lastIdx]?.toFixed(2),
            macd: macd.macdLine[lastIdx]?.toFixed(2),
            signal: macd.signalLine[lastIdx]?.toFixed(2),
          },
          levels: { nearestSupport, nearestResistance },
          chartData: data.map((d, i) => ({
            ...d,
            sma20: sma20[i],
            sma50: sma50[i],
            ema9: ema9[i],
          })),
        };
      };

      useEffect(() => {
        const data = generatePriceData();
        setPriceData(data);
        const result = analyzeConfluences(data);
        setAnalysis(result);
      }, []);

      const handleRefresh = () => {
        const data = generatePriceData();
        setPriceData(data);
        const result = analyzeConfluences(data);
        setAnalysis(result);
      };

      const getSignalColor = (signal) => {
        if (signal.includes('BUY')) return 'text-green-600';
        if (signal.includes('SELL')) return 'text-red-600';
        return 'text-gray-600';
      };

      const getSignalBg = (signal) => {
        if (signal.includes('BUY')) return 'bg-green-100 border-green-300';
        if (signal.includes('SELL')) return 'bg-red-100 border-red-300';
        return 'bg-gray-100 border-gray-300';
      };

      const getTrendIcon = (signal) => {
        if (signal.includes('BUY')) return React.createElement(TrendingUp, { className: "w-6 h-6" });
        if (signal.includes('SELL')) return React.createElement(TrendingDown, { className: "w-6 h-6" });
        return React.createElement(Minus, { className: "w-6 h-6" });
      };

      return (
        <div className="w-full min-h-screen bg-gray-50 p-6">
          <div className="max-w-7xl mx-auto">
            <div className="flex justify-between items-center mb-6">
              <h1 className="text-3xl font-bold text-gray-800">Trading Confluence Analyzer</h1>
              <button
                onClick={handleRefresh}
                className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
              >
                Generate New Data
              </button>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
              <div className="bg-white p-4 rounded-lg shadow">
                <label className="block text-sm font-medium text-gray-700 mb-2">Symbol</label>
                <input
                  type="text"
                  value={symbol}
                  onChange={(e) => setSymbol(e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                />
              </div>
              <div className="bg-white p-4 rounded-lg shadow">
                <label className="block text-sm font-medium text-gray-700 mb-2">Timeframe</label>
                <select
                  value={timeframe}
                  onChange={(e) => setTimeframe(e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                >
                  <option>5M</option>
                  <option>15M</option>
                  <option>1H</option>
                  <option>4H</option>
                  <option>1D</option>
                </select>
              </div>
              <div className="bg-white p-4 rounded-lg shadow">
                <label className="block text-sm font-medium text-gray-700 mb-2">Current Price</label>
                <div className="text-2xl font-bold text-gray-800">
                  ${priceData[priceData.length - 1]?.close.toFixed(2)}
                </div>
              </div>
            </div>

            {analysis && (
              <>
                <div className={`mb-6 p-6 rounded-lg shadow border-2 ${getSignalBg(analysis.trendSignal)}`}>
                  <div className="flex items-center justify-between">
                    <div>
                      <h2 className="text-xl font-semibold text-gray-700 mb-2">Overall Signal</h2>
                      <div className={`text-4xl font-bold ${getSignalColor(analysis.trendSignal)}`}>
                        {analysis.trendSignal}
                      </div>
                      <div className="text-sm text-gray-600 mt-2">
                        Confluence Score: {analysis.trendScore}
                      </div>
                    </div>
                    <div className={getSignalColor(analysis.trendSignal)}>
                      {getTrendIcon(analysis.trendSignal)}
                    </div>
                  </div>
                </div>

                <div className="bg-white p-6 rounded-lg shadow mb-6">
                  <h2 className="text-xl font-semibold text-gray-700 mb-4">Price Chart with Indicators</h2>
                  <LineChart width={1000} height={400} data={analysis.chartData}>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis dataKey="time" />
                    <YAxis domain={['auto', 'auto']} />
                    <Tooltip />
                    <Legend />
                    <Line type="monotone" dataKey="close" stroke="#1f77b4" name="Price" strokeWidth={2} dot={false} />
                    <Line type="monotone" dataKey="sma20" stroke="#ff7f0e" name="SMA 20" strokeWidth={1.5} dot={false} />
                    <Line type="monotone" dataKey="sma50" stroke="#2ca02c" name="SMA 50" strokeWidth={1.5} dot={false} />
                    <Line type="monotone" dataKey="ema9" stroke="#d62728" name="EMA 9" strokeWidth={1.5} dot={false} />
                  </LineChart>
                </div>

                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                  <div className="bg-white p-6 rounded-lg shadow">
                    <h2 className="text-xl font-semibold text-gray-700 mb-4">Technical Indicators</h2>
                    <div className="space-y-3">
                      <div className="flex justify-between">
                        <span className="text-gray-600">SMA 20:</span>
                        <span className="font-semibold">${analysis.indicators.sma20}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">SMA 50:</span>
                        <span className="font-semibold">${analysis.indicators.sma50}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">EMA 9:</span>
                        <span className="font-semibold">${analysis.indicators.ema9}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">RSI (14):</span>
                        <span className="font-semibold">{analysis.indicators.rsi}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">MACD:</span>
                        <span className="font-semibold">{analysis.indicators.macd}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">Signal:</span>
                        <span className="font-semibold">{analysis.indicators.signal}</span>
                      </div>
                    </div>
                  </div>

                  <div className="bg-white p-6 rounded-lg shadow">
                    <h2 className="text-xl font-semibold text-gray-700 mb-4">Support & Resistance</h2>
                    <div className="space-y-4">
                      {analysis.levels.nearestResistance && (
                        <div className="p-3 bg-red-50 rounded border border-red-200">
                          <div className="text-sm text-gray-600">Nearest Resistance</div>
                          <div className="text-lg font-semibold text-red-600">
                            ${analysis.levels.nearestResistance.price.toFixed(2)}
                          </div>
                          <div className="text-xs text-gray-500">
                            {((analysis.levels.nearestResistance.price - priceData[priceData.length - 1].close) / priceData[priceData.length - 1].close * 100).toFixed(2)}% away
                          </div>
                        </div>
                      )}
                      {analysis.levels.nearestSupport && (
                        <div className="p-3 bg-green-50 rounded border border-green-200">
                          <div className="text-sm text-gray-600">Nearest Support</div>
                          <div className="text-lg font-semibold text-green-600">
                            ${analysis.levels.nearestSupport.price.toFixed(2)}
                          </div>
                          <div className="text-xs text-gray-500">
                            {((priceData[priceData.length - 1].close - analysis.levels.nearestSupport.price) / priceData[priceData.length - 1].close * 100).toFixed(2)}% away
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                </div>

                <div className="bg-white p-6 rounded-lg shadow">
                  <h2 className="text-xl font-semibold text-gray-700 mb-4">Active Confluences</h2>
                  <div className="space-y-2">
                    {analysis.confluences.map((conf, idx) => (
                      <div
                        key={idx}
                        className={`flex items-center justify-between p-3 rounded ${
                          conf.signal === 'BULLISH' ? 'bg-green-50 border border-green-200' :
                          conf.signal === 'BEARISH' ? 'bg-red-50 border border-red-200' :
                          'bg-yellow-50 border border-yellow-200'
                        }`}
                      >
                        <div className="flex items-center gap-2">
                          {conf.signal === 'WARNING' && React.createElement(AlertCircle, { className: "w-4 h-4 text-yellow-600" })}
                          <span className="font-medium">{conf.name}</span>
                        </div>
                        <div className="flex items-center gap-3">
                          <span className={`px-3 py-1 rounded text-sm font-semibold ${
                            conf.signal === 'BULLISH' ? 'bg-green-600 text-white' :
                            conf.signal === 'BEARISH' ? 'bg-red-600 text-white' :
                            'bg-yellow-600 text-white'
                          }`}>
                            {conf.signal}
                          </span>
                          <span className="text-sm text-gray-600">Weight: {conf.weight}</span>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </>
            )}
          </div>
        </div>
      );
    };

    ReactDOM.render(<TradingApp />, document.getElementById('root'));
  </script>
</body>
</html>
